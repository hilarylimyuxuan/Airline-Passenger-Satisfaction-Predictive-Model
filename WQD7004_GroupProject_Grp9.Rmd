---
title: "WQD7004 Group Project - Group 9"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 2
    number_sections: true
    theme: spacelab
---

# Introduction
This is introduction

# Objectives

# Methodology

## Data Understanding

```{r include = FALSE, warning = FALSE}
# load library
library(stringr)
library(dplyr)
library(data.table)

# read csv
airline_df <- read.csv("Airline Passenger Satisfaction Dataset\\train_unclean.csv"
                       , header = TRUE
                       , stringsAsFactors = TRUE)

# display dataframe
head(airline_df)

# data dimension
dim(airline_df)

# data class
sapply(airline_df, class)

# summary statistics
summary(airline_df)
```

## Data Cleaning

```{r include = FALSE, warning = FALSE}
# check duplicate
dim(airline_df[duplicated(airline_df$id),])[1]
# no duplicate

# check NA count in each column
colSums(is.na(airline_df))
# Departure.Delay.in.Minutes: 92
# Arrival.Delay.in.Minutes: 310

# check distinct values for each categorical column
levels(airline_df$Gender)
levels(airline_df$Customer.Type)
levels(airline_df$Type.of.Travel)
levels(airline_df$Class)
```

```{r include = FALSE, warning = FALSE}
# data cleaning
# convert gender and customer type into proper case
airline_df$Gender.C = as.factor(str_to_title(airline_df$Gender))
levels(airline_df$Gender)
airline_df$Customer.Type.C = as.factor(str_to_title(airline_df$Customer.Type))
levels(airline_df$Customer.Type)

# clean type of travel
airline_df$Type.of.Travel.C <- 
  ifelse(grepl('^b', airline_df$Type.of.Travel, ignore.case = TRUE), 
         "Business Travel",
         "Personal Travel")
airline_df$Type.of.Travel.C <- as.factor(airline_df$Type.of.Travel.C)
levels(airline_df$Type.of.Travel.C)

# clean class
airline_df$Class.C <- 
  ifelse(grepl('^b', airline_df$Class, ignore.case = TRUE), 
         "Business",
         ifelse(grepl('^(ekon|econ|Eco$)', airline_df$Class, ignore.case = TRUE),
                "Eco",
                "Eco Plus")
         )
airline_df$Class.C <- as.factor(airline_df$Class.C)
levels(airline_df$Class.C)

# clean inflight wifi service rating
# set ratings above 5 as NA and replace with mean exclude 0
airline_df$Inflight.wifi.service.C <- airline_df$Inflight.wifi.service
airline_df$Inflight.wifi.service.C[airline_df$Inflight.wifi.service.C > 5] <- NA
airline_df$Inflight.wifi.service.C[is.na(airline_df$Inflight.wifi.service.C)] <-
  mean(airline_df$Inflight.wifi.service.C
       [airline_df$Inflight.wifi.service.C > 0]
       , na.rm = TRUE
       )
# convert to integer
airline_df$Inflight.wifi.service.C <- 
  round(airline_df$Inflight.wifi.service.C)

# clean food and drink rating
# set ratings above 5 as NA and replace with mean exclude 0
airline_df$Food.and.drink.C <- airline_df$Food.and.drink
airline_df$Food.and.drink.C[airline_df$Food.and.drink.C > 5] <- NA
airline_df$Food.and.drink.C[is.na(airline_df$Food.and.drink.C)] <-
  mean(airline_df$Food.and.drink.C
       [airline_df$Food.and.drink.C > 0]
       , na.rm = TRUE
       )
# convert to integer
airline_df$Food.and.drink.C <- 
  round(airline_df$Food.and.drink.C)

# clean seat comfort
# set ratings above 5 as NA and replace with mean exclude 0
airline_df$Seat.comfort.C <- airline_df$Seat.comfort
airline_df$Seat.comfort.C[airline_df$Seat.comfort.C > 5] <- NA
airline_df$Seat.comfort.C[is.na(airline_df$Seat.comfort.C)] <-
  mean(airline_df$Seat.comfort.C
       [airline_df$Seat.comfort.C > 0]
       , na.rm = TRUE
       )
# convert to integer
airline_df$Seat.comfort.C <- 
  round(airline_df$Seat.comfort.C)

# convert all ratings column to ordinal factor
ratings <- c("Inflight.wifi.service.C", "Food.and.drink.C", "Seat.comfort.C",
          "Departure.Arrival.time.convenient",	"Ease.of.Online.booking",
          "Gate.location", "Online.boarding", "Inflight.entertainment",
          "On.board.service",	"Leg.room.service",	"Baggage.handling",
          "Checkin.service",	"Inflight.service",	"Cleanliness"
          )
airline_df[ratings] <- lapply(airline_df[ratings], 
                              factor, 
                              levels=c(0, 1, 2, 3, 4, 5)
                              )

# replace NA with 0
# Departure & Arrival delay in minutes
delay_cols <- c("Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes")
airline_df[delay_cols][is.na(airline_df[delay_cols])] <- 0

# rearrange columns
col_order <- c("X", "id", "Gender", "Gender.C", "Customer.Type",
               "Customer.Type.C", "Age", "Type.of.Travel", "Type.of.Travel.C",
               "Class", "Class.C","Flight.Distance", "Inflight.wifi.service", 
               "Inflight.wifi.service.C", "Departure.Arrival.time.convenient",	
               "Ease.of.Online.booking", "Gate.location", "Food.and.drink",
               "Food.and.drink.C", "Online.boarding", "Seat.comfort", 
               "Seat.comfort.C", "Inflight.entertainment", "On.board.service",	
               "Leg.room.service", "Baggage.handling", "Checkin.service",	
               "Inflight.service",	"Cleanliness", "Departure.Delay.in.Minutes",
               "Arrival.Delay.in.Minutes", "satisfaction"
               )
airline_df <- airline_df[, col_order]

# drop columns
drop_col <- c("Gender", "Customer.Type", "Type.of.Travel", "Class",
              "Inflight.wifi.service", "Food.and.drink", "Seat.comfort")
airline_df[, drop_col] <- list(NULL)

# rename columns
old_colnames <- c("Gender.C", "Customer.Type.C", "Type.of.Travel.C", "Class.C", 
                  "Inflight.wifi.service.C", "Food.and.drink.C", "Seat.comfort.C"
                  )
new_colnames <- drop_col
setnames(airline_df, old = old_colnames, new = new_colnames)
```

```{r include = FALSE, warning = FALSE}
write.csv(airline_df,'Airline Passenger Satisfaction Dataset\\train_clean.csv')
```

## Analyses
# Visualization
install.packages('ggrepel')
install.packages('GGally')
install.packages('vip')
install.packages('patchwork')
install.packages('ggplot2')
install.packages('dplyr')
install.packages('magrittr')

library(ggrepel)
library(GGally)
library(vip)
library(patchwork)
library(ggplot2)
library(dplyr)
library(magrittr) 


#2a customer gender by customer type- table
cs_gender_cust_type_df <- airline_df %>%
  group_by(Gender, Customer.Type) %>%
  summarise(counts = n())
  cs_gender_cust_type_df 
#2b customer gender by customer type- graph
cs_gender_cust_type_g <- 
  ggplot(cs_gender_cust_type_df, 
         aes(x = Customer.Type,
             y = counts)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "Customer Type", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral")+ 
  ggtitle("Customer Type by Gender in Train Dataset")
cs_gender_cust_type_g

#3a customer gender by customer type and type of travel- table
cs_gender_cust_type_travel_df <- airline_df %>%
  group_by(Gender, Customer.Type, Type.of.Travel) %>%
  summarise(counts = n())
  cs_gender_cust_type_travel_df 
#3b customer gender by customer type and type of travel- graph
cs_gender_cust_type_travel_g <- 
  ggplot(cs_gender_cust_type_travel_df, 
         aes(x = Customer.Type,
             y = counts, 
             fill = Type.of.Travel)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "Customer.Type", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral")+ 
  ggtitle("Customer Type by Gender and Travel Type in Train Dataset")
cs_gender_cust_type_travel_g


#4a customer gender by type of travel and class- table
cs_gender_travel_class_df <- airline_df %>%
  group_by(Gender, Type.of.Travel, Class) %>%
  summarise(counts = n())
  cs_gender_travel_class_df 
#4b customer type by type of travel and class- graph
cs_gender_travel_class_g <- 
  ggplot(cs_gender_travel_class_df, 
         aes(x = Type.of.Travel,
             y = counts, 
             fill = Class)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "Type of Travel", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral")+ 
  ggtitle("Customer Type by Travel Type and Class in Train Dataset")
cs_gender_travel_class_g

#5a Create age group
airline_df["age_group"] = cut(airline_df$Age, c(0, 10, 20, 30, 40, 50, 60, 70, 80, Inf), c("0-10", "11-20", "21-30","31-40","41-50","51-60","61-70","71-80", ">80"), include.lowest=TRUE)

#5b customer gender by age group and customer type- table
cs_gender_age_type_df <- airline_df %>%
  group_by(Gender, age_group,Customer.Type) %>%
  summarise(counts = n())
  cs_gender_age_type_df 
#5c customer gender by age group and customer type- graph
cs_gender_age_type_g <- 
  ggplot(cs_gender_age_type_df, 
         aes(x = age_group,
             y = counts,
             fill = Customer.Type)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "age_group", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral")+ 
  ggtitle("Customer Type by Gender and Age Group in Train Dataset")
cs_gender_age_type_g

#6a Satisfaction count graph
satisfaction_count <- airline_df %>% 
  count(satisfaction) %>% 
  ggplot(aes(x = satisfaction, y = n, fill = satisfaction)) +
  geom_bar(stat = "identity", colour = "black", alpha = 0.75) +
  geom_text(aes(label = n), 
                position=position_dodge(width=0.9), 
                vjust=-0.5) + 
  ylim(0, 60000) + 
  labs(y = "Count") + 
  scale_fill_brewer(palette="Spectral") + 
  ggtitle("Satisfaction variable in Train Dataset")
satisfaction_count

#6b customer gender by satisfaction- table
cs_gender_satisfied_df <- airline_df %>%
  group_by(Gender, satisfaction) %>%
  summarise(counts = n())
  cs_gender_satisfied_df 
  
#6c customer gender by satisfaction- graph
cs_gender_satisfied_g <- 
  ggplot(cs_gender_satisfied_df, 
         aes(x = satisfaction,
             y = counts)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "satisfaction", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral") + 
  ggtitle("Satisfaction by Gender in Train Dataset")
cs_gender_satisfied_g

#6d customer gender by age group and satisfaction- table
cs_gender_age_satisfied_df <- airline_df %>%
  group_by(Gender, age_group, satisfaction) %>%
  summarise(counts = n())
  cs_gender_age_satisfied_df 
  
#6e customer gender by age group and satisfaction- graph
cs_gender_age_satisfied_g <- 
  ggplot(cs_gender_age_satisfied_df, 
         aes(x = satisfaction,
             y = counts,
             fill = age_group)) + 
  geom_bar(stat='identity', position = "dodge") +
  labs(x = "satisfaction", y = "Frequency") + 
  facet_wrap(~Gender) +
  scale_fill_brewer(palette="Spectral") + 
  ggtitle("Satisfaction by Gender and Age Group in Train Dataset")
cs_gender_age_satisfied_g

#7 age histogram
age_hist<- ggplot(data = airline_df, aes( x = Age)) + 
  geom_density(fill="navy blue", color="black", alpha=0.75) +
  labs(title = "Distribution of Age", 
       subtitle = "Airline Passenger Satisfaction")
age_hist       


# Results

# Conclusion
